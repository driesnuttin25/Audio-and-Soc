#include "xiicps.h"
#include "xil_printf.h"

#define ADXL345_ADDR 0x53
#define ADXL345_REG_DATA_X0 0x32

XIicPs IicInstance;

void initI2C() {
    XIicPs_Config *Config;
    int Status;

    Config = XIicPs_LookupConfig(XPAR_XIICPS_0_DEVICE_ID);
    if (Config == NULL) {
        xil_printf("Error: XIicPs_LookupConfig failed\r\n");
        return;
    }

    Status = XIicPs_CfgInitialize(&IicInstance, Config, Config->BaseAddress);
    if (Status != XST_SUCCESS) {
        xil_printf("Error: XIicPs_CfgInitialize failed\r\n");
        return;
    }

    Status = XIicPs_SelfTest(&IicInstance);
    if (Status != XST_SUCCESS) {
        xil_printf("Error: XIicPs_SelfTest failed\r\n");
        return;
    }

    Status = XIicPs_SetSClk(&IicInstance, 100000);
    if (Status != XST_SUCCESS) {
        xil_printf("Error: XIicPs_SetSClk failed\r\n");
        return;
    }
}

int16_t readADXL345XAxis() {
    u8 recvBuffer[2];
    int Status;

    Status = XIicPs_MasterRecvPolled(&IicInstance, recvBuffer, 2, ADXL345_ADDR);
    if (Status != XST_SUCCESS) {
        xil_printf("Error: XIicPs_MasterRecvPolled failed\r\n");
        return -1;
    }

    int16_t accX = (recvBuffer[1] << 8) | recvBuffer[0];
    return accX;
}

int main() {
    init_platform();
    initI2C();

    while (1) {
        int16_t accX = readADXL345XAxis();
        xil_printf("Acceleration X: %d\r\n", accX);
        usleep(1000000); // Delay for 1 second
    }

    cleanup_platform();
    return 0;
}
