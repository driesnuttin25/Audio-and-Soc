#include "xtmrctr.h"
#include "xparameters.h"
#include "xil_printf.h"
#include "gpiops.h" // Include XGPIO for GPIO operations

#define PWM_PERIOD 100000000    // PWM period (adjust based on your requirements)
#define TIMER_DEVICE_ID XPAR_TMRCTR_0_DEVICE_ID
#define GPIO_DEVICE_ID XPAR_GPIO_0_DEVICE_ID  // Assumed GPIO device ID

// Function prototypes
void SetDutyCycle(XTmrCtr *InstancePtr, u32 Channel, u32 DutyCyclePercentage);

int main() {
    XTmrCtr TimerCounterInst;  // Timer instance
    XGpio Gpio;                // GPIO instance for direction control
    int Status;
    u32 DutyCycle;

    // Initialize the timer counter
    Status = XTmrCtr_Initialize(&TimerCounterInst, TIMER_DEVICE_ID);
    if (Status != XST_SUCCESS) {
        xil_printf("Timer initialization failed\r\n");
        return XST_FAILURE;
    }

    // Initialize the GPIO for direction control
    Status = XGpio_Initialize(&Gpio, GPIO_DEVICE_ID);
    if (Status != XST_SUCCESS) {
        xil_printf("GPIO initialization failed\r\n");
        return XST_FAILURE;
    }

    // Set GPIO direction to output on the specified channels (1 for output)
    XGpio_SetDataDirection(&Gpio, 1, 0x0); // Assuming channel 1 controls GP0 and GP1

    // Set both GP0 and GP1 high
    XGpio_DiscreteWrite(&Gpio, 1, 0x3); // Set both GP0 and GP1 high

    // Set up timer for auto reload and down count
    XTmrCtr_SetOptions(&TimerCounterInst, 0, XTC_AUTO_RELOAD_OPTION | XTC_DOWN_COUNT_OPTION);
    XTmrCtr_SetResetValue(&TimerCounterInst, 0, PWM_PERIOD - 1);
    XTmrCtr_Start(&TimerCounterInst, 0);

    xil_printf("Starting PWM code with GPIO pins set high.\r\n");
    while (1) {
        // Set duty cycle to 100%
        SetDutyCycle(&TimerCounterInst, 0, 100);
        xil_printf("Duty Cycle set to 100%%\r\n");
        sleep(5);  // sleep for 5 seconds

        // Set duty cycle to 50%
        SetDutyCycle(&TimerCounterInst, 0, 50);
        xil_printf("Duty Cycle set to 50%%\r\n");
        sleep(5);  // sleep for 5 seconds
    }

    // Should never reach here
    XTmrCtr_Stop(&TimerCounterInst, 0);
    return XST_SUCCESS;
}

// Function to set the duty cycle of PWM
void SetDutyCycle(XTmrCtr *InstancePtr, u32 Channel, u32 DutyCyclePercentage) {
    u32 HighTime = (PWM_PERIOD * DutyCyclePercentage) / 100;
    XTmrCtr_SetResetValue(InstancePtr, Channel, PWM_PERIOD - 1);
    XTmrCtr_SetResetValue(InstancePtr, Channel, HighTime - 1);
}
